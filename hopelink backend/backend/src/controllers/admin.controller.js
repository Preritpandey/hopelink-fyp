// import { StatusCodes } from 'http-status-codes';
// import Organization from '../models/organization.model.js';
// import User from '../models/user.model.js';
// import { BadRequestError, NotFoundError } from '../errors/index.js';
// import { generateRandomPassword } from '../utils/helpers.js';
// import { sendEmail, emailTemplates } from '../services/email.service.js';

// // @desc    Get all organizations with optional filtering
// // @route   GET /api/admin/orgs
// // @access  Private/Admin
// export const getAllOrganizations = async (req, res) => {
//   try {
//     const { status } = req.query;
//     const query = {};
    
//     if (status) {
//       query.status = status;
//     }

//     const organizations = await Organization.find(query)
//       .populate({
//         path: 'user',
//         select: 'email name',
//         model: 'User'
//       })
//       .populate({
//         path: 'approvedBy',
//         select: 'name email',
//         model: 'User'
//       })
//       .sort({ createdAt: -1 });

//     res.status(StatusCodes.OK).json({
//       success: true,
//       count: organizations.length,
//       data: organizations,
//     });
//   } catch (error) {
//     console.error('Error in getAllOrganizations:', error);
//     res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
//       success: false,
//       error: {
//         message: 'Error fetching organizations',
//         details: error.message
//       }
//     });
//   }
// };

// // @desc    Get pending organizations
// // @route   GET /api/admin/orgs/pending
// // @access  Private/Admin
// export const getPendingOrganizations = async (req, res) => {
//   try {
//     const organizations = await Organization.find({ status: 'pending' })
//       .populate({
//         path: 'user',
//         select: 'email name',
//         model: 'User'
//       })
//       .sort({ createdAt: -1 });

//     res.status(StatusCodes.OK).json({
//       success: true,
//       count: organizations.length,
//       data: organizations,
//     });
//   } catch (error) {
//     console.error('Error in getPendingOrganizations:', error);
//     res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
//       success: false,
//       error: {
//         message: 'Error fetching pending organizations',
//         details: error.message
//       }
//     });
//   }
// };

// // @desc    Approve organization
// // @route   PUT /api/admin/orgs/approve/:id
// // @access  Private/Admin
// export const approveOrganization = async (req, res) => {
//   const { id } = req.params;
  
//   try {
//     const organization = await Organization.findById(id);
//     console.log("organization id ", id);
    
//     if (!organization) {
//       throw new NotFoundError('Organization not found');
//     }

//     if (organization.status !== 'pending') {
//       throw new BadRequestError('Organization is not in pending status');
//     }

//     // If organization doesn't have a user, create one
//     if (!organization.user) {
//       const password = generateRandomPassword(12);
//       const user = new User({
//         name: organization.representativeName,
//         email: organization.officialEmail,
//         password: password,
//         role: 'organization',
//         isVerified: true,
//         isPasswordAutogenerated: true
//       });
//       await user.save();
//        await sendApprovalEmail(org, password);
//       console.log("Created new user for organization", user._id);
      
//       // Link user to organization
//       organization.user = user._id;
//     } else {
//       // If user exists, update their status
//       const user = await User.findById(organization.user);
//       if (user) {
//         console.log("Updating existing user to verified status", user._id);
//         user.isVerified = true;
//         await user.save();
//       }
//     }

//     // Update organization status
//     organization.status = 'approved';
//     organization.isVerified = true;
//     organization.approvedBy = req.user.userId;
//     organization.approvedAt = new Date();
    
//     await organization.save();



//     res.status(StatusCodes.OK).json({
//       success: true,
//       message: 'Organization approved successfully',
//       data: organization,
//     });
//   } catch (error) {
//     console.error('Error approving organization:', error);
//     res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
//       success: false,
//       error: {
//         message: 'Error approving organization',
//         details: error.message
//       }
//     });
//   }
// };

// // @desc    Reject organization
// // @route   PUT /api/admin/orgs/reject/:id
// // @access  Private/Admin
// export const rejectOrganization = async (req, res) => {
//   const { id } = req.params;
//   const { reason } = req.body;

//   try {
//     const organization = await Organization.findById(id);
    
//     if (!organization) {
//       throw new NotFoundError('Organization not found');
//     }

//     if (organization.status !== 'pending') {
//       throw new BadRequestError('Organization is not in pending status');
//     }

//     // Update organization status
//     organization.status = 'rejected';
//     organization.rejectionReason = reason || 'No reason provided';
//     organization.approvedBy = req.user.userId;
//     organization.approvedAt = new Date();
    
//     await organization.save();

//     // Populate the organization with user data for response
//     const populatedOrg = await Organization.findById(organization._id)
//       .populate('user', 'email name')
//       .populate('approvedBy', 'name email');

//     // Send rejection email if organization has an email
//     if (organization.officialEmail) {
//       try {
//         const emailData = {
//           to: organization.officialEmail,
//           subject: 'Your Organization Registration Has Been Rejected',
//           template: 'organization-rejected',
//           context: {
//             organizationName: organization.organizationName,
//             reason: organization.rejectionReason,
//             contactEmail: process.env.SUPPORT_EMAIL || 'support@hopelink.com',
//           },
//         };
//         await sendEmail(emailData);
//       } catch (emailError) {
//         console.error('Error sending rejection email:', emailError);
//         // Continue even if email fails
//       }
//     }

//     res.status(StatusCodes.OK).json({
//       success: true,
//       message: 'Organization rejected successfully',
//       data: populatedOrg,
//     });
//   } catch (error) {
//     console.error('Error rejecting organization:', error);
//     res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
//       success: false,
//       error: {
//         message: 'Error rejecting organization',
//         details: error.message
//       }
//     });
//   }
// };
// const sendApprovalEmail = async (org, password) => {
//   try {
//     await sendEmail({
//       to: org.officialEmail,
//       subject: 'Your Organization Has Been Approved! üéâ',
//       html: `
//         <div style="font-family: Arial, sans-serif;">
//           <h2 style="color:#4CAF50;">Congratulations, ${org.representativeName}!</h2>
//           <p>Your organization <strong>${org.organizationName}</strong> has been approved.</p>
//           <div style="background:#f9f9f9;padding:15px;border-radius:5px;">
//             <p><strong>Email:</strong> ${org.officialEmail}</p>
//             <p><strong>Password:</strong> ${password}</p>
//           </div>
//           <p>Please change your password after your first login.</p>
//           <a href="${process.env.FRONTEND_URL}/login" style="background:#4CAF50;color:white;padding:10px 20px;border-radius:5px;text-decoration:none;">Login Now</a>
//         </div>
//       `,
//     });
//   } catch (err) {
//     console.error('Failed to send approval email:', err);
//   }
// };

import { StatusCodes } from 'http-status-codes';
import Organization from '../models/organization.model.js';
import User from '../models/user.model.js';
import { BadRequestError, NotFoundError } from '../errors/index.js';
import { generateRandomPassword } from '../utils/helpers.js';
import { sendEmail, emailTemplates } from '../services/email.service.js';

// @desc    Get all organizations with optional filtering
// @route   GET /api/admin/orgs
// @access  Private/Admin
export const getAllOrganizations = async (req, res) => {
  try {
    const { status } = req.query;
    const query = {};
    
    if (status) {
      query.status = status;
    }

    const organizations = await Organization.find(query)
      .populate({
        path: 'user',
        select: 'email name',
        model: 'User'
      })
      .populate({
        path: 'approvedBy',
        select: 'name email',
        model: 'User'
      })
      .sort({ createdAt: -1 });

    res.status(StatusCodes.OK).json({
      success: true,
      count: organizations.length,
      data: organizations,
    });
  } catch (error) {
    console.error('Error in getAllOrganizations:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error fetching organizations',
        details: error.message
      }
    });
  }
};

// @desc    Get pending organizations
// @route   GET /api/admin/orgs/pending
// @access  Private/Admin
export const getPendingOrganizations = async (req, res) => {
  try {
    const organizations = await Organization.find({ status: 'pending' })
      .populate({
        path: 'user',
        select: 'email name',
        model: 'User'
      })
      .sort({ createdAt: -1 });

    res.status(StatusCodes.OK).json({
      success: true,
      count: organizations.length,
      data: organizations,
    });
  } catch (error) {
    console.error('Error in getPendingOrganizations:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error fetching pending organizations',
        details: error.message
      }
    });
  }
};

// @desc    Approve organization
// @route   PUT /api/admin/orgs/approve/:id
// @access  Private/Admin
export const approveOrganization = async (req, res) => {
  const { id } = req.params;
  
  try {
    const organization = await Organization.findById(id);
    console.log("organization id ", id);
    
    if (!organization) {
      throw new NotFoundError('Organization not found');
    }

    if (organization.status !== 'pending') {
      throw new BadRequestError('Organization is not in pending status');
    }

    let password = null;
    let user = null;

    // Check if organization already has a linked user
    if (!organization.user) {
      // Check if a user with this email already exists
      user = await User.findOne({ email: organization.officialEmail });
      
      if (user) {
        // User exists, link to organization and verify
        console.log("Found existing user with email", organization.officialEmail);
        organization.user = user._id;
        user.isVerified = true;
        user.role = 'organization'; // Update role if needed
        await user.save();
        
        // Send approval email without password
        await sendApprovalEmailExistingUser(organization);
      } else {
        // Create new user
        password = generateRandomPassword(12);
        user = new User({
          name: organization.representativeName,
          email: organization.officialEmail,
          password: password,
          role: 'organization',
          isVerified: true,
          isPasswordAutogenerated: true
        });
        await user.save();
        
        console.log("Created new user for organization", user._id);
        
        // Link user to organization
        organization.user = user._id;
        
        // Send approval email with password
        await sendApprovalEmail(organization, password);
      }
    } else {
      // Organization has a linked user, update their status
      user = await User.findById(organization.user);
      if (user) {
        console.log("Updating existing user to verified status", user._id);
        user.isVerified = true;
        await user.save();
        
        // Send approval email without password
        await sendApprovalEmailExistingUser(organization);
      }
    }

    // Update organization status
    organization.status = 'approved';
    organization.isVerified = true;
    organization.approvedBy = req.user.userId;
    organization.approvedAt = new Date();
    
    await organization.save();

    res.status(StatusCodes.OK).json({
      success: true,
      message: 'Organization approved successfully',
      data: organization,
    });
  } catch (error) {
    console.error('Error approving organization:', error);
    
    // Handle duplicate key error specifically
    if (error.code === 11000) {
      return res.status(StatusCodes.CONFLICT).json({
        success: false,
        error: {
          message: 'A user with this email already exists',
          details: 'Please link the existing user account or use a different email'
        }
      });
    }
    
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error approving organization',
        details: error.message
      }
    });
  }
};

// @desc    Reject organization
// @route   PUT /api/admin/orgs/reject/:id
// @access  Private/Admin
export const rejectOrganization = async (req, res) => {
  const { id } = req.params;
  const { reason } = req.body;

  try {
    const organization = await Organization.findById(id);
    
    if (!organization) {
      throw new NotFoundError('Organization not found');
    }

    if (organization.status !== 'pending') {
      throw new BadRequestError('Organization is not in pending status');
    }

    // Update organization status
    organization.status = 'rejected';
    organization.rejectionReason = reason || 'No reason provided';
    organization.approvedBy = req.user.userId;
    organization.approvedAt = new Date();
    
    await organization.save();

    // Populate the organization with user data for response
    const populatedOrg = await Organization.findById(organization._id)
      .populate('user', 'email name')
      .populate('approvedBy', 'name email');

    // Send rejection email if organization has an email
    if (organization.officialEmail) {
      try {
        const emailData = {
          to: organization.officialEmail,
          subject: 'Your Organization Registration Has Been Rejected',
          template: 'organization-rejected',
          context: {
            organizationName: organization.organizationName,
            reason: organization.rejectionReason,
            contactEmail: process.env.SUPPORT_EMAIL || 'support@hopelink.com',
          },
        };
        await sendEmail(emailData);
      } catch (emailError) {
        console.error('Error sending rejection email:', emailError);
        // Continue even if email fails
      }
    }

    res.status(StatusCodes.OK).json({
      success: true,
      message: 'Organization rejected successfully',
      data: populatedOrg,
    });
  } catch (error) {
    console.error('Error rejecting organization:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error rejecting organization',
        details: error.message
      }
    });
  }
};

// Helper function to send approval email with password (new user)
const sendApprovalEmail = async (organization, password) => {
  try {
    await sendEmail({
      to: organization.officialEmail,
      subject: 'Your Organization Has Been Approved! üéâ',
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #4CAF50;">Congratulations, ${organization.representativeName}!</h2>
          <p>Your organization <strong>${organization.organizationName}</strong> has been approved.</p>
          
          <div style="background: #f9f9f9; padding: 20px; border-radius: 5px; margin: 20px 0;">
            <h3 style="margin-top: 0;">Your Login Credentials</h3>
            <p style="margin: 10px 0;"><strong>Email:</strong> ${organization.officialEmail}</p>
            <p style="margin: 10px 0;"><strong>Password:</strong> <code style="background: #e8e8e8; padding: 5px 10px; border-radius: 3px;">${password}</code></p>
          </div>
          
          <p style="color: #ff9800;"><strong>‚ö†Ô∏è Important:</strong> Please change your password after your first login for security purposes.</p>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="${process.env.FRONTEND_URL}/login" 
               style="background: #4CAF50; color: white; padding: 12px 30px; border-radius: 5px; text-decoration: none; display: inline-block;">
              Login Now
            </a>
          </div>
          
          <p style="color: #666; font-size: 14px; margin-top: 30px;">
            If you have any questions, please contact our support team.
          </p>
        </div>
      `,
    });
    console.log(`Approval email sent to ${organization.officialEmail}`);
  } catch (err) {
    console.error('Failed to send approval email:', err);
    throw err; // Re-throw to handle in the main function
  }
};

// Helper function to send approval email for existing user (no password)
const sendApprovalEmailExistingUser = async (organization) => {
  try {
    await sendEmail({
      to: organization.officialEmail,
      subject: 'Your Organization Has Been Approved! üéâ',
      html: `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
          <h2 style="color: #4CAF50;">Congratulations, ${organization.representativeName}!</h2>
          <p>Your organization <strong>${organization.organizationName}</strong> has been approved.</p>
          
          <p>You can now log in with your existing credentials to access all features.</p>
          
          <div style="text-align: center; margin: 30px 0;">
            <a href="${process.env.FRONTEND_URL}/login" 
               style="background: #4CAF50; color: white; padding: 12px 30px; border-radius: 5px; text-decoration: none; display: inline-block;">
              Login Now
            </a>
          </div>
          
          <p style="color: #666; font-size: 14px; margin-top: 30px;">
            If you have any questions, please contact our support team.
          </p>
        </div>
      `,
    });
    console.log(`Approval email sent to ${organization.officialEmail}`);
  } catch (err) {
    console.error('Failed to send approval email:', err);
    throw err;
  }
};