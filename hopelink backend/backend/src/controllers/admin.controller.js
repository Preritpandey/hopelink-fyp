import { StatusCodes } from 'http-status-codes';
import Organization from '../models/organization.model.js';
import User from '../models/user.model.js';
import { BadRequestError, NotFoundError } from '../errors/index.js';
import { generateRandomPassword } from '../utils/helpers.js';
import { sendEmail, emailTemplates } from '../services/email.service.js';

// @desc    Get all organizations with optional filtering
// @route   GET /api/admin/orgs
// @access  Private/Admin
export const getAllOrganizations = async (req, res) => {
  try {
    const { status } = req.query;
    const query = {};
    
    if (status) {
      query.status = status;
    }

    const organizations = await Organization.find(query)
      .populate({
        path: 'user',
        select: 'email name',
        model: 'User'
      })
      .populate({
        path: 'approvedBy',
        select: 'name email',
        model: 'User'
      })
      .sort({ createdAt: -1 });

    res.status(StatusCodes.OK).json({
      success: true,
      count: organizations.length,
      data: organizations,
    });
  } catch (error) {
    console.error('Error in getAllOrganizations:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error fetching organizations',
        details: error.message
      }
    });
  }
};

// @desc    Get pending organizations
// @route   GET /api/admin/orgs/pending
// @access  Private/Admin
export const getPendingOrganizations = async (req, res) => {
  try {
    const organizations = await Organization.find({ status: 'pending' })
      .populate({
        path: 'user',
        select: 'email name',
        model: 'User'
      })
      .sort({ createdAt: -1 });

    res.status(StatusCodes.OK).json({
      success: true,
      count: organizations.length,
      data: organizations,
    });
  } catch (error) {
    console.error('Error in getPendingOrganizations:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error fetching pending organizations',
        details: error.message
      }
    });
  }
};

// @desc    Approve organization
// @route   PUT /api/admin/orgs/approve/:id
// @access  Private/Admin
export const approveOrganization = async (req, res) => {
  const { id } = req.params;
  
  try {
    const organization = await Organization.findById(id);
    
    if (!organization) {
      throw new NotFoundError('Organization not found');
    }

    if (organization.status !== 'pending') {
      throw new BadRequestError('Organization is not in pending status');
    }

    // If organization doesn't have a user, create one
    if (!organization.user) {
      const password = generateRandomPassword(12);
      const user = new User({
        name: organization.representativeName,
        email: organization.officialEmail,
        password: password,
        role: 'organization',
        isVerified: true,
        isPasswordAutogenerated: true
      });
      await user.save();
      
      // Link user to organization
      organization.user = user._id;
    } else {
      // If user exists, update their status
      const user = await User.findById(organization.user);
      if (user) {
        user.isVerified = true;
        await user.save();
      }
    }

    // Update organization status
    organization.status = 'approved';
    organization.isVerified = true;
    organization.approvedBy = req.user.userId;
    organization.approvedAt = new Date();
    
    await organization.save();

    // Populate the organization with user data for response
    const populatedOrg = await Organization.findById(organization._id)
      .populate('user', 'email name')
      .populate('approvedBy', 'name email');

    // Send approval email
    try {
      const emailData = {
        to: organization.officialEmail,
        subject: 'Your Organization Has Been Approved',
        template: 'organization-approved',
        context: {
          organizationName: organization.organizationName,
          email: organization.officialEmail,
          loginUrl: `${process.env.FRONTEND_URL}/login`,
        },
      };
      await sendEmail(emailData);
    } catch (emailError) {
      console.error('Error sending approval email:', emailError);
      // Continue even if email fails
    }

    res.status(StatusCodes.OK).json({
      success: true,
      message: 'Organization approved successfully',
      data: populatedOrg,
    });
  } catch (error) {
    console.error('Error approving organization:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error approving organization',
        details: error.message
      }
    });
  }
};

// @desc    Reject organization
// @route   PUT /api/admin/orgs/reject/:id
// @access  Private/Admin
export const rejectOrganization = async (req, res) => {
  const { id } = req.params;
  const { reason } = req.body;

  try {
    const organization = await Organization.findById(id);
    
    if (!organization) {
      throw new NotFoundError('Organization not found');
    }

    if (organization.status !== 'pending') {
      throw new BadRequestError('Organization is not in pending status');
    }

    // Update organization status
    organization.status = 'rejected';
    organization.rejectionReason = reason || 'No reason provided';
    organization.approvedBy = req.user.userId;
    organization.approvedAt = new Date();
    
    await organization.save();

    // Populate the organization with user data for response
    const populatedOrg = await Organization.findById(organization._id)
      .populate('user', 'email name')
      .populate('approvedBy', 'name email');

    // Send rejection email if organization has an email
    if (organization.officialEmail) {
      try {
        const emailData = {
          to: organization.officialEmail,
          subject: 'Your Organization Registration Has Been Rejected',
          template: 'organization-rejected',
          context: {
            organizationName: organization.organizationName,
            reason: organization.rejectionReason,
            contactEmail: process.env.SUPPORT_EMAIL || 'support@hopelink.com',
          },
        };
        await sendEmail(emailData);
      } catch (emailError) {
        console.error('Error sending rejection email:', emailError);
        // Continue even if email fails
      }
    }

    res.status(StatusCodes.OK).json({
      success: true,
      message: 'Organization rejected successfully',
      data: populatedOrg,
    });
  } catch (error) {
    console.error('Error rejecting organization:', error);
    res.status(StatusCodes.INTERNAL_SERVER_ERROR).json({
      success: false,
      error: {
        message: 'Error rejecting organization',
        details: error.message
      }
    });
  }
};
